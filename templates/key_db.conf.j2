# KeyDB single-node with ACL auth (default user disabled), generated by Ansible.

port {{ key_db_port }}
bind 0.0.0.0
protected-mode no
databases {{ key_db_databases }}

# ---- Auth / ACL ----
requirepass {{ key_db_password | mandatory }}
masterauth {{ key_db_password | mandatory }}
user default on >{{ key_db_password | mandatory }} ~* +@all

# --- Persistence ---
appendonly {{ key_db_appendonly }}
appendfsync {{ key_db_appendfsync }}
{% for rule in key_db_save_intervals %}
save {{ rule }}
{% endfor %}

# --- Memory / eviction ---
{% if key_db_maxmemory %}
maxmemory {{ key_db_maxmemory }}
maxmemory-policy {{ key_db_maxmemory_policy }}
{% endif %}

# --- Logging ---
loglevel notice

# ---- Topology ----
{% if key_db_topology == 'multi_master' %}
active-replica yes
multi-master yes
{%   for peer in key_db_peer_list %}
replicaof {{ peer.host }} {{ peer.port }}
{%   endfor %}
{% elif key_db_topology == 'replica' %}
# Single-master follower
replicaof {{ key_db_master_host }} {{ key_db_master_port }}
{% endif %}